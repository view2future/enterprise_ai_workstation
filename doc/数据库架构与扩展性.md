# 数据库架构与扩展性

## 1. 灵活的架构设计

为了支持企业数据库字段的动态扩展，我们实现了结合传统列和动态属性存储的灵活架构。这种方法允许添加新字段而无需架构迁移。

### 1.1 企业表结构
```sql
-- 带动态属性列的企业原始表
CREATE TABLE enterprises (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    unified_social_credit_code VARCHAR(18) UNIQUE,
    registration_number VARCHAR(50),
    legal_representative VARCHAR(100),
    registered_capital DECIMAL(15,2),
    registration_date DATE,
    business_status VARCHAR(50),
    industry_type VARCHAR(100), -- 用于常用字段
    sub_industry VARCHAR(100),
    region VARCHAR(100),
    city VARCHAR(100),
    district VARCHAR(100),
    address TEXT,
    employee_count INTEGER,
    annual_revenue BIGINT, -- 以百万人民币为单位的收入
    website VARCHAR(255),
    contact_person VARCHAR(100),
    contact_phone VARCHAR(50),
    contact_email VARCHAR(255),
    remarks TEXT,
    
    -- 新增：动态属性存储扩展字段
    dynamic_attributes JSONB DEFAULT '{}',
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by UUID REFERENCES users(id),
    updated_by UUID REFERENCES users(id)
);
```

### 1.2 自定义字段定义表
```sql
-- 定义可用的自定义字段（架构注册表）
CREATE TABLE custom_field_definitions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    field_name VARCHAR(100) UNIQUE NOT NULL,
    field_label VARCHAR(255) NOT NULL,
    field_type VARCHAR(50) NOT NULL CHECK (field_type IN ('text', 'number', 'date', 'boolean', 'select', 'multiselect', 'textarea')),
    field_group VARCHAR(100), -- 逻辑分组字段（例如"财务"、"运营"）
    is_required BOOLEAN DEFAULT FALSE,
    is_visible BOOLEAN DEFAULT TRUE,
    validation_rules JSONB, -- 存储验证规则如最小值/最大值、正则表达式等
    select_options TEXT[], -- 用于选择/多选字段
    sort_order INTEGER DEFAULT 0,
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 1.3 激活的自定义字段表
```sql
-- 跟踪哪些自定义字段对给定实体类型处于活动状态
CREATE TABLE active_custom_fields (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    field_definition_id UUID REFERENCES custom_field_definitions(id) ON DELETE CASCADE,
    entity_type VARCHAR(50) DEFAULT 'enterprise', -- 如果我们稍后扩展到其他实体
    is_active BOOLEAN DEFAULT TRUE,
    required_for_import BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 2. 数据库迁移策略

### 2.1 安全添加自定义字段
- 验证字段名称唯一性
- 创建字段定义
- 为实体类型激活字段
- 记录更改用于审计

### 2.2 更新现有自定义字段
- 修改字段定义
- 如字段类型或验证规则更改，验证现有数据
- 保持数据完整性

### 2.3 停用自定义字段
- 软删除方法保留数据
- 可选择性地匿名化/移除停用字段的数据

## 3. 扩展性特点

### 3.1 动态属性存储
- `dynamic_attributes` JSONB列可存储任何数量的额外字段
- 无需架构更改即可添加新字段

### 3.2 字段定义注册表
- `custom_field_definitions` 表存储每个自定义字段的元数据
- 包括类型、验证规则和选项

### 3.3 字段激活控制
- `active_custom_fields` 表允许管理员启用/禁用字段
- 无需删除定义即可进行控制

### 3.4 兼容性
- 现有功能保持不变
- 新字段可以透明添加

### 3.5 查询能力
- PostgreSQL的JSONB函数允许查询动态属性

## 4. 数据验证

### 4.1 字段验证规则
- 数值：最小值、最大值验证
- 日期：格式验证
- 布尔：类型验证
- 选择：选项验证
- 文本：长度、正则表达式验证

### 4.2 数据完整性
- 动态属性验证
- 现有数据验证
- 类型安全检查

这种架构设计提供了企业数据的灵活性和可扩展性，同时保持系统的稳定性和数据完整性。