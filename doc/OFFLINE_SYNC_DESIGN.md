# 离线数据同步与协作方案 (Offline Sync & Collaboration Design)

## 1. 背景与目标
为了支持小组成员在各自的 Mac 端独立运行项目，同时能够方便、安全地共享与维护企业数据库，本方案设计了一套基于“离线文件交换”的协同机制。
- **核心模式**：Local-first（本地优先）+ AirDrop/文件传输。
- **主要目标**：确保数据一致性、安全性，并提供极佳的用户交互体验。

## 2. 数据交换格式：.eap (Enterprise AI Package)
采用自定义格式以确保数据的结构完整性与安全性。
- **底层技术**：Gzip 压缩后的 JSON。
- **安全保障**：AES-256-GCM 对称加密（可选，需配置共享密钥）。
- **结构组成**：
  - `metadata`: 包含版本号、导出时间、操作人、校验和（SHA256）、记录总数。
  - `payload`: 包含完整的企业实体数据及 JSON 嵌套字段。
  - `changes`: 记录增量变更日志，方便冲突合并。

## 3. 技术方案 (Technical Specification)

### 3.1 核心技术栈
- **压缩库**: `pako` (Zlib/Gzip 实现)，用于极大缩小数据包体积。
- **加密库**: `crypto-js` 或 Web Crypto API，采用 `AES-256-GCM` 确保端到端安全。
- **数据验证**: `Zod`，用于在导入时对 JSON 结构进行严耕的 Schema 校验。
- **动画引擎**: `Framer Motion`，负责数据对接、传送门及粒子特效。
- **状态管理**: `Zustand`，管理同步任务的全局状态与进度。

### 3.2 导出流程 (Export Logic)
1. **数据提取**: 通过 Prisma 提取 `updatedAt > last_sync_time` 的记录。
2. **结构化处理**: 将企业主表及关联的 JSON 字段序列化。
3. **加密与压缩**: 
   - `const encrypted = AES.encrypt(JSON.stringify(data), secret).toString();`
   - `const compressed = pako.gzip(encrypted);`
4. **封装导出**: 封装为 `.eap` 二进制文件，触发浏览器下载。
5. **本地联动 (Dev Mode)**: 脚本检测到下载完成后，自动执行 `open .` 弹出 Finder。

### 3.3 导入流程 (Import Logic)
1. **文件流读取**: `FileReader.readAsArrayBuffer`。
2. **解压与解密**: 逆向执行导出流程，校验密文完整性。
3. **语义化对比 (Semantic Diff)**:
   - 遍历 `payload`，根据 `unifiedSocialCreditCode` 匹配本地记录。
   - 对比字段，若本地 `updatedAt` 更早，标记为“待更新”；若存在冲突（双向修改），标记为“待对决”。
4. **事务写入**: 使用 `prisma.$transaction` 批量更新记录并记录 `SyncLog`。

### 3.4 冲突解决 (Conflict Resolution)
- **差异对比**: 当导入数据与本地数据存在冲突时，系统展示侧边栏对比视图。
- **字段级合并**: 用户可以选择保留特定的字段更新（例如：保留本地的“联系人信息”，但采用导入包中的“年度营收”）。

## 4. 用户体验设计 (UX & Gamification)

### 4.1 趣味化视觉隐喻
为了减少维护数据的枯燥感，交互设计采用“AI 进化”与“数据对接”的科技感风格。
- **数据胶囊 (Data Core)**：导出过程伴随粒子聚集动画，模拟物理封装。
- **时空传送门 (Portal)**：导入区域设计为动态脉冲圆环，文件拖入时产生磁吸视觉。
- **X光扫描 (X-Ray Scanning)**：文件解析阶段通过横向扫描线模拟数据完整性检测，配合趣味文案（如：*“正在检索 316 家成都企业的 AI 脉络...”*）。

### 4.2 交互反馈
- **触感反馈 (Haptics)**：利用 Mac Trackpad 的 Force Touch，在导出完成和导入成功时提供物理震动反馈。
- **VS 冲突对决**：冲突记录以卡片形式“格斗式”排列，通过视觉对比直观呈现差异，用户点击即完成“吸收”或“覆盖”。
- **成就系统**：导入成功后显示“同步达成”勋章，并统计本次同步对“西南 AI 数据库”的贡献度（如：*“已更新 10% 的行业趋势数据”*）。

## 5. 操作流程 (Workflow)
1. **小王** 在本地更新了 5 家成都企业的融资信息，点击“导出数据胶囊”。
2. **小王** 通过 AirDrop 将生成的 `EAW_Data_20251221.eap` 发送给 **小李**。
3. **小李** 将文件拖入系统的“数据传送门”。
4. 系统扫描发现 2 条冲突，**小李** 在 UI 上点击选择“保留最新”，完成同步。

---
*注：本方案旨在不依赖中心化服务器的前提下，最大化提升团队协作效率与操作趣味性。*
