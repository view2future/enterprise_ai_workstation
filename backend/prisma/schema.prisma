// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./nexus_desktop.db"
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  email     String   @unique
  password  String
  firstName String?
  lastName  String?
  role      String   @default("analyst")
  status    String   @default("active")
  envScope  String   @default("PROD") // 区分环境：DEMO 或 PROD
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  auditLogs AuditLog[]
  veracityTasks VeracityTask[]
  
  @@map("users")
}

model Enterprise {
  id                Int      @id @default(autoincrement())
  enterpriseName    String   @unique @map("企业名称")
  envScope          String   @default("PROD") @map("环境域")
  feijiangWenxin    String?  @map("飞桨_文心")
  clueInTime        String?  @map("线索入库时间")
  clueUpdateTime    DateTime? @map("线索更新时间")
  partnerLevel      String?  @map("伙伴等级")
  ecoAIProducts     String?  @map("生态AI产品")
  priority          String?  @map("优先级")
  base              String?  @map("base")
  registeredCapital BigInt?  @map("注册资本")
  employeeCount     Int?     @map("参保人数")
  enterpriseBackground String? @map("企业背景")
  industry          String?    @map("行业")
  taskDirection     String?  @map("任务方向")
  contactInfo       String?  @map("联系人信息")
  usageScenario     String?  @map("使用场景")
  status            String   @default("active")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  createdBy         String?
  updatedBy         String?

  // 企业自身信息完善
  unifiedSocialCreditCode String?   @map("统一社会信用代码")
  legalRepresentative     String?   @map("法定代表人")
  establishmentDate       DateTime? @map("成立日期")
  enterpriseType          String?   @map("企业类型")
  annualRevenue           String?   @map("年度营收规模")
  techStaffCount          Int?      @map("技术研发人数")
  isHighTech              Boolean?  @default(false) @map("是否高新企业")
  isSpecialized           Boolean?  @default(false) @map("是否专精特新")
  website                 String?   @map("公司官网")
  officeAddress           String?   @map("详细办公地址")

  // 百度AI技术应用
  paddleUsageLevel        String?   @map("飞桨应用深度")
  paddleModels            String?     @map("飞桨具体模型")
  paddleTrainingType      String?   @map("飞桨训练模式")
  ernieModelType          String?   @map("文心大模型版本")
  ernieAppScenarios       String?     @map("文心应用场景")
  promptTemplateCount     Int?      @default(0) @map("提示词模板数")
  avgMonthlyApiCalls      BigInt?   @default(0) @map("月均API调用量")
  peakApiCalls            Int?      @default(0) @map("峰值并发量")
  inferenceComputeType    String?   @map("推理算力类型")
  aiImplementationStage   String?   @map("AI落地阶段")

  // 生态合作与活动
  partnerProgramType      String?   @map("生态项目类别")
  baiduCertificates       String?     @map("百度AI认证证书")
  eventParticipation      String?     @map("参与活动记录")
  jointSolutions          String?     @map("联合解决方案")
  isBaiduVenture          Boolean?  @default(false) @map("百度是否投资")
  trainingRecord          String?     @map("技术培训记录")
  awardsReceived          String?     @map("获奖记录")
  lastContactDept         String?   @map("百度最近对接部门")

  // 数据灾备与审计
  dataIntegrityHash       String?   @map("数据完整性哈希")
  lastAuditTime           DateTime? @map("最后审计时间")
  isArchived              Boolean   @default(false) @map("是否已归档")
  dataSourceType          String?   @default("manual") @map("数据来源")
  
  // VERACITY HUD 扩展字段
  isVerified              Boolean   @default(false) @map("是否已真值校验")
  veracityScore           Int       @default(0) @map("真值置信度")
  lastVeracityCheck       DateTime? @map("最后校验时间")
  evidenceChain           String?     @map("证据链数据")
  
  @@map("enterprises")
}

model AuditLog {
  id          Int      @id @default(autoincrement())
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  action      String   // CREATE, UPDATE, DELETE, SYNC_IMPORT
  entityType  String   // Enterprise, Report
  entityId    Int?
  details     String?  // 操作描述
  oldValue    String?
  newValue    String?
  timestamp   DateTime @default(now())
  ipAddress   String?

  @@map("audit_logs")
}

model VeracityTask {
  id            String   @id @default(uuid())
  targetName    String
  status        String   @default("PENDING") // PENDING, RUNNING, COMPLETED, FAILED
  progress      Int      @default(0)
  step          String?
  resultData    String?
  envScope      String   @default("PROD")
  userId        Int
  user          User     @relation(fields: [userId], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("veracity_tasks")
}

model Report {
  id             Int       @id @default(autoincrement())
  title          String
  type           String
  format         String
  status         String    @default("pending")
  description    String?
  filters        String?
  configuration  String?
  filePath       String?
  fileName       String?
  dataCount      Int       @default(0)
  progress       Int       @default(0)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  completedAt    DateTime?
  createdBy      String?
  errorMessage   String?
  envScope       String    @default("PROD") @map("环境域")
  
  @@map("reports")
}
